<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Teman Ngobrol - Ruang Dengar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2C7A7B;
      --primary-hover: #256969;
      --primary-light: #e6f7f7;
      --primary-lighter: #f0fafa;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --bg-main: #f8fafc;
      --bg-white: #ffffff;
      --bg-sidebar: #ffffff;
      --success: #10b981;
      --unread-badge: #2C7A7B;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
      --sidebar-width: 360px;
      --app-height: 100vh;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      height: var(--app-height);
      overflow: hidden;
    }

    /* Layout - Desktop 2-column, Mobile single view */
    .app-container {
      display: flex;
      height: var(--app-height);
      overflow: hidden;
    }

    /* Sidebar / Chat List */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      height: var(--app-height);
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      object-fit: cover;
      box-shadow: var(--shadow-sm);
    }

    .brand-text {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--primary-lighter) 0%, var(--bg-main) 100%);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--primary) 0%, #38a3a5 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .user-role {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .logout-btn {
      padding: 7px 14px;
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: var(--bg-main);
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    /* Sessions Section */
    .sessions-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* Modern Tabs */
    .tabs {
      display: flex;
      padding: 12px 16px;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--bg-white);
    }

    .tab-btn {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-btn:hover {
      color: var(--text-primary);
      background: var(--bg-main);
    }

    .tab-btn.active {
      color: var(--primary);
      background: var(--primary-light);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }

    .section-title {
      padding: 14px 20px 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px 12px;
      min-height: 0;
    }

    .sessions-list::-webkit-scrollbar {
      width: 6px;
    }

    .sessions-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .sessions-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .sessions-list::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
    }

    /* Session Item - Modern Style */
    .session-item {
      padding: 12px 14px;
      margin-bottom: 6px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      background: var(--bg-white);
    }

    .session-item:hover {
      background: var(--bg-main);
      border-color: var(--border);
    }

    .session-item.active {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .session-item.has-unread {
      background: linear-gradient(135deg, var(--primary-lighter) 0%, #f0f9ff 100%);
      border-color: rgba(44, 122, 123, 0.2);
    }

    .session-avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .session-content {
      flex: 1;
      min-width: 0;
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .session-topic {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      margin-right: 8px;
    }

    .session-time {
      font-size: 11px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .session-item.has-unread .session-time {
      color: var(--primary);
      font-weight: 600;
    }

    .session-preview {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .session-last-message {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .session-item.has-unread .session-last-message {
      color: var(--text-primary);
      font-weight: 500;
    }

    .unread-badge {
      background: var(--unread-badge);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 12px;
      min-width: 22px;
      text-align: center;
      flex-shrink: 0;
    }

    .session-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .session-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      background: var(--bg-main);
      border-radius: 4px;
      font-size: 11px;
    }

    .session-item.active .session-badge {
      background: white;
    }

    /* User Item - Clickable Row Style */
    .user-item {
      padding: 12px 14px;
      margin-bottom: 6px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      background: var(--bg-white);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-item:hover {
      background: var(--bg-main);
      border-color: var(--border);
    }

    .user-item.active {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .user-item-avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .user-item-content {
      flex: 1;
      min-width: 0;
    }

    .user-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
    }

    .user-item-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-item-sessions {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-main);
      padding: 2px 8px;
      border-radius: 10px;
      flex-shrink: 0;
    }

    .user-item-preview {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-item-info {
      flex: 1;
      min-width: 0;
    }

    .user-item-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .user-item-btn {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .user-item-btn:hover {
      background: var(--primary-hover);
    }

    .user-item-btn.secondary {
      background: var(--bg-main);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .user-item-btn.secondary:hover {
      background: var(--border);
    }

    /* Empty State - Sidebar */
    .empty-sessions {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 14px;
      background: var(--bg-main);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-icon svg {
      width: 26px;
      height: 26px;
      stroke: var(--text-muted);
    }

    .empty-text {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-main);
      min-width: 0;
      height: var(--app-height);
      overflow: hidden;
    }

    /* Chat Area - 3-part layout */
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* Chat Header - Fixed at top */
    .chat-header {
      padding: 16px 24px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 10;
    }

    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .chat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--success);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
    }

    /* Messages - Scrollable middle section */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 24px;
      padding-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
    }

    .messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .message {
      max-width: 65%;
      display: flex;
      flex-direction: column;
    }

    .message.user {
      align-self: flex-start;
    }

    .message.companion {
      align-self: flex-end;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      line-height: 1.5;
    }

    .message.user .message-bubble {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message.companion .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .message.companion .message-info {
      justify-content: flex-end;
    }

    /* System Message */
    .message.system {
      align-self: center;
      max-width: 85%;
    }

    .message.system .system-bubble {
      background: #fef3c7;
      color: #92400e;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      text-align: center;
    }

    /* Empty Chat - Enhanced */
    .empty-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-muted);
      padding: 40px;
      background: var(--bg-main);
    }

    .empty-chat-card {
      background: var(--bg-white);
      border-radius: var(--radius-xl);
      padding: 48px 40px;
      max-width: 420px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }

    .empty-chat-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, var(--primary-light) 0%, #e0f2fe 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-chat-icon svg {
      width: 36px;
      height: 36px;
      stroke: var(--primary);
    }

    .empty-chat-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-chat-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .empty-chat-tips {
      background: var(--bg-main);
      border-radius: var(--radius-md);
      padding: 14px 18px;
      text-align: left;
    }

    .empty-chat-tips-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .empty-chat-tips-title svg {
      width: 14px;
      height: 14px;
      stroke: var(--primary);
    }

    .empty-chat-tips-list {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    .empty-chat-tips-list li {
      margin-bottom: 4px;
      padding-left: 4px;
    }

    .empty-chat-stats {
      display: flex;
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Input Area - Sticky at bottom (Composer) */
    .input-area {
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: var(--bg-white);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }

    .input-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      line-height: 1.5;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(44, 122, 123, 0.1);
    }

    .input-field::placeholder {
      color: var(--text-muted);
    }

    .send-button {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, #38a3a5 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      height: 44px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(44, 122, 123, 0.25);
    }

    .send-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(44, 122, 123, 0.3);
    }

    .send-button:active {
      transform: translateY(0);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .send-button svg {
      width: 16px;
      height: 16px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar {
        width: 300px;
      }
    }

    /* ========================================
       MOBILE VIEW MODE - Single Screen Navigation
       ======================================== */
    @media (max-width: 768px) {
      .app-container {
        display: block;
        position: relative;
      }

      /* Chat List (Sidebar) - Full width in mobile */
      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: var(--app-height);
        z-index: 10;
        border-right: none;
        transform: none;
        transition: none;
        box-shadow: none;
      }

      /* Main Content / Chat Panel - Full width in mobile */
      .main-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: var(--app-height);
        z-index: 10;
      }

      /* VIEW MODE: List (default on mobile) */
      .app-container.view-list .sidebar {
        display: flex;
        z-index: 20;
      }

      .app-container.view-list .main-content {
        display: none;
      }

      /* VIEW MODE: Chat (when chat is selected) */
      .app-container.view-chat .sidebar {
        display: none;
      }

      .app-container.view-chat .main-content {
        display: flex;
        z-index: 20;
      }

      /* Hide hamburger mobile header, we don't need drawer anymore */
      .mobile-header {
        display: none !important;
      }

      /* Overlay not needed for mobile view mode */
      .overlay {
        display: none !important;
      }

      /* Chat header with back button */
      .chat-header {
        padding: 12px 16px;
        flex-shrink: 0;
      }

      .chat-back-btn {
        display: flex !important;
      }

      #chatArea {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 16px;
        padding-bottom: 8px;
        min-height: 0;
      }

      .input-area {
        padding: 10px 12px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        flex-shrink: 0;
      }

      .input-form {
        gap: 8px;
      }

      .input-field {
        padding: 10px 14px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .send-button {
        padding: 10px 16px;
        height: 42px;
      }

      .empty-chat-card {
        padding: 32px 24px;
        margin: 16px;
      }

      .empty-chat-stats {
        flex-direction: column;
        gap: 12px;
      }
    }

    /* Back button in chat header (hidden on desktop) */
    .chat-back-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-main);
      border-radius: var(--radius-sm);
      cursor: pointer;
      margin-right: 12px;
      flex-shrink: 0;
      transition: background 0.2s;
    }

    .chat-back-btn:hover {
      background: var(--border);
    }

    .chat-back-btn svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-primary);
    }

    /* Desktop: hide mobile header completely */
    .mobile-header {
      display: none;
      padding: 14px 16px;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .menu-button {
      padding: 10px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .menu-button:hover {
      background: var(--bg-main);
    }

    .menu-button svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
    }

    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 99;
      backdrop-filter: blur(2px);
    }

    .overlay.active {
      display: block;
    }

    /* Modal styles */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
    }

    .modal-card {
      position: relative;
      background: var(--bg-white);
      border-radius: 14px;
      padding: 20px 22px;
      width: 420px;
      max-width: calc(100% - 40px);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      z-index: 201;
      text-align: left;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .modal-body {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-secondary {
      padding: 8px 12px;
      background: var(--bg-main);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 600;
    }

    .btn-danger {
      padding: 8px 12px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    /* Admin menu icon in chat header */
    .admin-menu-btn {
      background: var(--bg-main);
      border: 1px solid var(--border);
      font-size: 20px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 8px 10px;
      border-radius: 8px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .admin-menu-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      border-color: #fecaca;
    }

    /* Chat header layout */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    /* Admin menu button positioned on the right */
    .chat-header .admin-menu-btn {
      flex-shrink: 0;
      margin-left: auto;
    }

    .chat-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Anonymous badge */
    .anon-badge {
      display: inline-block;
      padding: 2px 6px;
      margin-left: 8px;
      background: var(--primary-light);
      color: var(--primary);
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Session subtitle in list */
    .session-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    /* Status closed */
    .status-dot.status-closed {
      background: var(--text-muted);
    }

    /* Input disabled when room is closed */
    .input-area.input-disabled {
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: var(--bg-main);
      border-top: 1px solid var(--border);
      text-align: center;
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
    }

    .input-disabled-hint {
      font-size: 13px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: var(--text-primary);
      color: white;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      animation: toast-in 0.3s ease;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: #ef4444;
    }

    .toast-hide {
      animation: toast-out 0.3s ease forwards;
    }

    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes toast-out {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
  </style>
</head>
<body>
  <!-- App Container with view mode class -->
  <div class="app-container view-list" id="appContainer">
    <!-- Sidebar / Chat List -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <img src="assets/logo/logo-imadiksi.jpg" alt="Logo" class="brand-logo">
          <div>
            <div class="brand-text">Ruang Dengar</div>
            <div class="brand-subtitle">Dashboard Teman Ngobrol</div>
          </div>
        </div>
        
        <div class="user-info">
          <div class="user-details">
            <div class="user-avatar" id="userAvatar">-</div>
            <div>
              <div class="user-name" id="userName">Loading...</div>
              <div class="user-role" id="userRole">-</div>
            </div>
          </div>
          <button class="logout-btn" id="logoutBtn">Keluar</button>
        </div>
      </div>

      <div class="sessions-section">
        <!-- Tabs (single) -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="sessions">Ruang Chat</button>
        </div>

        <!-- Sessions Tab -->
        <div class="tab-content active" id="sessionsTab">
          <div class="section-title">Ruang Chat Aktif</div>
          <div class="sessions-list" id="sessionsList">
            <div class="empty-sessions">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
              </div>
              <div class="empty-text">Belum ada ruang chat</div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content / Chat Panel -->
    <main class="main-content">
      <!-- Chat Area -->
      <div id="chatArea">
        <div class="empty-chat">
          <div class="empty-chat-card">
            <div class="empty-chat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <div class="empty-chat-title">Pilih Ruang Chat</div>
            <div class="empty-chat-text">Pilih percakapan dari daftar di samping untuk mulai memberikan dukungan kepada pengguna</div>
            
            <div class="empty-chat-tips">
              <div class="empty-chat-tips-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="16" x2="12" y2="12"/>
                  <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Tips
              </div>
              <ul class="empty-chat-tips-list">
                <li>Prioritaskan chat dengan badge unread terlebih dahulu</li>
                <li>Gunakan bahasa yang ramah dan empatik</li>
                <li>Jaga kerahasiaan percakapan pengguna</li>
              </ul>
            </div>
            
            <div class="empty-chat-stats" id="emptyStats" style="display: none;">
              <div class="stat-item">
                <div class="stat-number" id="statActive">0</div>
                <div class="stat-label">Chat Aktif</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="statWaiting">0</div>
                <div class="stat-label">Menunggu Balasan</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Close Room Confirmation -->
  <div id="closeGroupModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <h3 class="modal-title">Tutup Ruang Grup?</h3>
      <p class="modal-body">Ruang grup ini akan ditutup untuk semua pengguna dan tidak dapat digunakan lagi.</p>
      <div class="modal-actions">
        <button id="modalCancelBtn" class="btn-secondary">Batal</button>
        <button id="modalCloseRoomBtn" class="btn-danger">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // Mobile Viewport Height Fix
    // ========================================
    function setAppHeight() {
      const vh = window.innerHeight;
      document.documentElement.style.setProperty('--app-height', `${vh}px`);
    }

    // Set on load
    setAppHeight();

    // Update on resize (handles keyboard appearing/disappearing)
    window.addEventListener('resize', setAppHeight);
    window.addEventListener('orientationchange', () => {
      setTimeout(setAppHeight, 100); // Delay for orientation change
    });

    // ========================================
    // Mobile View Mode
    // ========================================
    function isMobile() {
      return window.innerWidth <= 768;
    }

    function setViewMode(mode) {
      // mode: 'list' or 'chat'
      const container = document.getElementById('appContainer');
      container.classList.remove('view-list', 'view-chat');
      container.classList.add(`view-${mode}`);
    }

    function showChatView() {
      if (isMobile()) {
        setViewMode('chat');
      }
    }

    function showListView() {
      if (isMobile()) {
        setViewMode('list');
        // Clear current session when going back to list
        state.currentSessionId = null;
        document.querySelectorAll('.session-item').forEach(item => {
          item.classList.remove('active');
        });
      }
    }

    // Handle browser back button on mobile
    window.addEventListener('popstate', (event) => {
      if (isMobile() && document.getElementById('appContainer').classList.contains('view-chat')) {
        showListView();
      }
    });

    // Initialize view mode on load and resize
    function initViewMode() {
      if (isMobile()) {
        // On mobile, default to list view
        setViewMode('list');
      } else {
        // On desktop, remove mobile view classes
        const container = document.getElementById('appContainer');
        container.classList.remove('view-list', 'view-chat');
      }
    }

    window.addEventListener('resize', initViewMode);

    // ========================================
    // State
    // ========================================
    const state = {
      companion: null,
      sessions: [],
      currentSessionId: null,
      messages: [],
      pollingInterval: null,
      activeTab: 'sessions',
    };

    // API Helper
    async function api(endpoint, options = {}) {
      const response = await fetch(`/api/companion${endpoint}`, {
        ...options,
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    // Format anonymous label for user privacy
    // Converts anon_number to "Pengguna 0XX" format
    function formatAnonLabel(n) {
      if (!n || n < 1) return 'Pengguna ---';
      return 'Pengguna ' + String(n).padStart(3, '0');
    }

    // Check auth
    async function checkAuth() {
      try {
        const data = await api('/me');
        state.companion = data.companion;
        
        document.getElementById('userName').textContent = state.companion.name;
        document.getElementById('userRole').textContent = state.companion.specialty;
        document.getElementById('userAvatar').textContent = state.companion.name.charAt(0).toUpperCase();
        
  loadSessions();
  setupTabs();
      } catch (err) {
        window.location.href = '/landing.html';
      }
    }

    // Setup tabs (single tab kept for sessions)
    function setupTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;

          // Update button states
          tabBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update tab content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabName + 'Tab').classList.add('active');

          state.activeTab = tabName;
        });
      });
    }

    // Track locally read sessions (persisted to localStorage)
    // Key format: readSessions_{companionId}_{sessionId} = timestamp
    function getReadSessionsFromStorage() {
      const data = {};
      const prefix = 'readSession_';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(prefix)) {
          const sessionId = key.replace(prefix, '');
          data[sessionId] = localStorage.getItem(key);
        }
      }
      return data;
    }

    function markSessionReadInStorage(sessionId) {
      localStorage.setItem(`readSession_${sessionId}`, new Date().toISOString());
    }

    function isSessionReadInStorage(sessionId, lastMessageTime) {
      const readAt = localStorage.getItem(`readSession_${sessionId}`);
      if (!readAt) return false;
      // Session is read if readAt is after lastMessageTime
      return new Date(readAt) >= new Date(lastMessageTime);
    }

    // Load sessions
    async function loadSessions() {
      try {
        const data = await api('/sessions');
        const newSessions = data.sessions || [];
        
        // Check localStorage for read status and adjust unreadCount
        state.sessions = newSessions.map(session => {
          // If session was read after the last message, set unreadCount to 0
          if (isSessionReadInStorage(session.sessionId, session.lastMessageTime)) {
            return { ...session, unreadCount: 0 };
          }
          return session;
        });
        
        renderSessions();
        updateEmptyStats();
      } catch (err) {
        console.error('Failed to load sessions:', err);
      }
    }

    // Update empty state stats
    function updateEmptyStats() {
      const statsContainer = document.getElementById('emptyStats');
      const statActive = document.getElementById('statActive');
      const statWaiting = document.getElementById('statWaiting');
      
      if (state.sessions.length > 0) {
        const activeCount = state.sessions.length;
        const waitingCount = state.sessions.filter(s => s.unreadCount > 0).length;
        
        statActive.textContent = activeCount;
        statWaiting.textContent = waitingCount;
        statsContainer.style.display = 'flex';
      } else {
        statsContainer.style.display = 'none';
      }
    }

    // Render sessions
    function renderSessions() {
      const container = document.getElementById('sessionsList');

      if (state.sessions.length === 0) {
        container.innerHTML = `
          <div class="empty-sessions">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <div class="empty-text">Belum ada ruang chat</div>
          </div>
        `;
        return;
      }

      container.innerHTML = state.sessions.map(session => {
        const hasUnread = session.unreadCount > 0;
        const lastMsg = session.lastMessage || 'Belum ada pesan';
        // Use anonymous label for user privacy
        const anonLabel = formatAnonLabel(session.anonNumber);
        const userInitial = 'P'; // P for "Pengguna"
        
        return `
          <div class="session-item ${session.sessionId === state.currentSessionId ? 'active' : ''} ${hasUnread ? 'has-unread' : ''}" 
               data-session-id="${session.sessionId}">
            <div class="session-avatar">${userInitial}</div>
            <div class="session-content">
              <div class="session-header">
                <div class="session-topic">${escapeHtml(anonLabel)}</div>
                <div class="session-time">${formatTime(session.lastMessageTime || session.createdAt)}</div>
              </div>
              <div class="session-preview">
                <div class="session-subtitle">${escapeHtml(session.topic)}</div>
                <div class="session-last-message">${escapeHtml(lastMsg)}</div>
                ${hasUnread ? `<span class="unread-badge">${session.unreadCount}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      container.querySelectorAll('.session-item').forEach(item => {
        item.addEventListener('click', () => {
          selectSession(item.dataset.sessionId);
        });
      });
    }

    // Mark session as read (optimistic update + API call + localStorage)
    async function markSessionAsRead(sessionId) {
      // Save to localStorage (survives page reload)
      markSessionReadInStorage(sessionId);
      
      // 1) Optimistic UI update: set unreadCount to 0 immediately
      const sessionIndex = state.sessions.findIndex(s => s.sessionId === sessionId);
      if (sessionIndex !== -1) {
        state.sessions[sessionIndex].unreadCount = 0;
        
        // Remove unread badge from UI immediately
        const sessionItem = document.querySelector(`.session-item[data-session-id="${sessionId}"]`);
        if (sessionItem) {
          sessionItem.classList.remove('has-unread');
          const badge = sessionItem.querySelector('.unread-badge');
          if (badge) badge.remove();
        }
      }

      // 2) Send to backend (fire and forget, don't block UI)
      try {
        await api('/read', {
          method: 'POST',
          body: JSON.stringify({ sessionId }),
        });
      } catch (err) {
        console.error('Failed to mark session as read:', err);
        // Silent fail - UI already updated, will sync on next load
      }
    }

    // Select session
    async function selectSession(sessionId) {
      const isNewSession = state.currentSessionId !== sessionId;
      state.currentSessionId = sessionId;
      
      // Mark as read immediately when selecting
      markSessionAsRead(sessionId);
      
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.toggle('active', item.dataset.sessionId === sessionId);
      });

      // Switch to chat view on mobile
      showChatView();

      // Load messages first
      await loadMessagesInitial(isNewSession);
      
      // Start polling for updates
      startPolling();
    }

    // Load messages (initial with session info)
    async function loadMessagesInitial(isNewSession) {
      if (!state.currentSessionId) return;

      try {
        const data = await api(`/messages?sessionId=${state.currentSessionId}`);
        state.messages = data.messages || [];
        
        // Only render full chat on new session selection
        if (isNewSession) {
          // Merge API session data with state session data (which has roomType)
          const stateSession = state.sessions.find(s => s.sessionId === state.currentSessionId);
          const sessionData = {
            ...data.session,
            roomType: stateSession?.roomType || 'private',
            status: stateSession?.status || 'active',
          };
          renderChat(sessionData);
        } else {
          updateMessagesArea();
        }
      } catch (err) {
        console.error('Failed to load messages:', err);
      }
    }

    // Load messages (for polling)
    async function loadMessages() {
      if (!state.currentSessionId) return;

      try {
        const data = await api(`/messages?sessionId=${state.currentSessionId}`);
        state.messages = data.messages || [];
        
        // Only update messages area, not entire chat
        updateMessagesArea();
      } catch (err) {
        console.error('Failed to load messages:', err);
      }
    }

    // Initial render chat (only called once when selecting session)
    function renderChat(session) {
      const chatArea = document.getElementById('chatArea');
      // Check if room is closed
      const isClosed = session.status === 'closed';
      // Check if this is a group room
      const isGroup = session.roomType === 'group';
      
      console.log('renderChat session:', session);
      console.log('isClosed:', isClosed, 'isGroup:', isGroup, 'roomType:', session.roomType);

      // Admin menu button ONLY for GROUP rooms (not for private chats)
      // Companion can only close group rooms, not private chats
      const adminMenuHtml = isGroup && !isClosed ? `
        <button class="admin-menu-btn" id="adminMenuBtn" title="Tutup Ruang Grup">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      ` : '';

      const inputAreaHtml = isClosed ? `
        <div class="input-area input-disabled">
          <div class="input-disabled-hint">Ruang chat ini telah ditutup oleh pendamping.</div>
        </div>
      ` : `
        <div class="input-area">
          <form class="input-form" id="messageForm">
            <div class="input-wrapper">
              <textarea 
                class="input-field"
                id="messageInput" 
                placeholder="Tulis balasan..." 
                rows="1"
                required
              ></textarea>
            </div>
            <button type="submit" class="send-button" id="sendBtn">
              Kirim
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </form>
        </div>
      `;

      // Use anonymous label for chat header
      const anonLabel = formatAnonLabel(session.anonNumber);

      // Back button for mobile navigation
      const backBtnHtml = `
        <button class="chat-back-btn" id="chatBackBtn" title="Kembali">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </button>
      `;

      chatArea.innerHTML = `
        <div class="chat-header">
          ${backBtnHtml}
          <div class="chat-header-left">
            <div class="chat-title">${escapeHtml(anonLabel)}</div>
            <div class="chat-subtitle">${escapeHtml(session.topic)}</div>
            <div class="chat-status">
              <span class="status-dot ${isClosed ? 'status-closed' : ''}"></span>
              ${isClosed ? 'Ditutup' : 'Aktif'}
              <span class="anon-badge">Anonim</span>
            </div>
          </div>
          ${adminMenuHtml}
        </div>
        <div class="messages-container" id="messagesArea">
        </div>
        ${inputAreaHtml}
      `;

      // Back button handler
      const backBtn = document.getElementById('chatBackBtn');
      if (backBtn) {
        backBtn.addEventListener('click', showListView);
      }

      // Admin menu click handler - always attach for closing chat
      const adminBtn = document.getElementById('adminMenuBtn');
      if (adminBtn) {
        adminBtn.addEventListener('click', () => {
          openCloseGroupModal(session.sessionId);
        });
      }

      // Add form handler (if not closed)
      const messageForm = document.getElementById('messageForm');
      if (messageForm) {
        messageForm.addEventListener('submit', sendMessage);
      }

      // Auto-resize textarea (if not closed)
      const textarea = document.getElementById('messageInput');
      if (textarea) {
        textarea.addEventListener('input', () => {
          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        });
      }

      // Initial messages render
      updateMessagesArea();
    }

    // Update only messages area (called during polling)
    function updateMessagesArea() {
      const messagesArea = document.getElementById('messagesArea');
      if (!messagesArea) return;

      const scrolledToBottom = messagesArea.scrollHeight - messagesArea.scrollTop <= messagesArea.clientHeight + 100;

      messagesArea.innerHTML = state.messages.length === 0 
        ? `<div class="empty-chat">
             <div class="empty-chat-icon">
               <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
               </svg>
             </div>
             <div class="empty-chat-title">Belum ada pesan</div>
             <div class="empty-chat-text">Kirim pesan pertama untuk memulai percakapan</div>
           </div>`
        : state.messages.map(msg => {
            // System message (e.g., room closed notification)
            if (msg.isSystem) {
              return `
                <div class="message system">
                  <div class="message-bubble system-bubble">${escapeHtml(msg.text)}</div>
                </div>
              `;
            }
            return `
              <div class="message ${msg.isCompanion ? 'companion' : 'user'}">
                <div class="message-bubble">${escapeHtml(msg.text)}</div>
                <div class="message-info">
                  <span>${escapeHtml(msg.displayName)}</span>
                  <span>${formatTime(msg.createdAt)}</span>
                </div>
              </div>
            `;
          }).join('');

      // Scroll to bottom if user was already at bottom
      if (scrolledToBottom || state.messages.length <= 1) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }
    }

    // Send message
    async function sendMessage(e) {
      e.preventDefault();

      const input = document.getElementById('messageInput');
      const btn = document.getElementById('sendBtn');
      const content = input.value.trim();

      if (!content || !state.currentSessionId) return;

      btn.disabled = true;

      try {
        await api('/messages', {
          method: 'POST',
          body: JSON.stringify({
            sessionId: state.currentSessionId,
            content,
          }),
        });

        input.value = '';
        input.style.height = 'auto';
        await loadMessages();
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    // Polling
    function startPolling() {
      if (state.pollingInterval) {
        clearInterval(state.pollingInterval);
      }

      state.pollingInterval = setInterval(() => {
        if (state.currentSessionId) {
          loadMessages();
        }
        loadSessions();
      }, 5000);
    }

    // Logout
    async function logout() {
      try {
        await fetch('/api/companion/logout', { 
          method: 'POST',
          credentials: 'include'
        });
      } catch (err) {
        console.error('Logout error:', err);
      }
      window.location.href = '/landing.html';
    }

    // ========== Modal: Close Group ==========
    let pendingCloseSessionId = null;

    function openCloseGroupModal(sessionId) {
      pendingCloseSessionId = sessionId;
      document.getElementById('closeGroupModal').style.display = 'flex';
    }

    function hideCloseGroupModal() {
      pendingCloseSessionId = null;
      document.getElementById('closeGroupModal').style.display = 'none';
    }

    async function confirmCloseGroup() {
      if (!pendingCloseSessionId) return;

      const sessionId = pendingCloseSessionId;
      hideCloseGroupModal();

      try {
        // Call API to close the group room
        await api('/close', {
          method: 'POST',
          body: JSON.stringify({ sessionId }),
        });

        // Remove session from list (it's now closed)
        state.sessions = state.sessions.filter(s => s.sessionId !== sessionId);

        // Clear current session if it was the one being closed
        if (state.currentSessionId === sessionId) {
          state.currentSessionId = null;
          state.messages = [];
          // Show empty state
          document.getElementById('chatArea').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
              </div>
              <h3 class="empty-state-title">Pilih Ruang Chat</h3>
              <p class="empty-state-text">Pilih percakapan dari daftar untuk memulai</p>
            </div>
          `;
        }

        // Re-render sessions list (closed room will be gone)
        renderSessions();

        // Show success notification
        showToast('Ruang grup berhasil ditutup');
      } catch (err) {
        console.error('Failed to close group:', err);
        showToast('Gagal menutup ruang grup', 'error');
      }
    }

    // Simple toast notification
    function showToast(message, type = 'success') {
      // Remove existing toast
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Modal event listeners
    document.getElementById('modalCancelBtn').addEventListener('click', hideCloseGroupModal);
    document.getElementById('modalCloseRoomBtn').addEventListener('click', confirmCloseGroup);
    document.querySelector('#closeGroupModal .modal-backdrop').addEventListener('click', hideCloseGroupModal);

    // Helpers
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Baru saja';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m lalu`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}j lalu`;
      
      return date.toLocaleDateString('id-ID', { 
        day: 'numeric', 
        month: 'short'
      });
    }

    // Event listeners
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Initialize view mode and auth
    initViewMode();
    checkAuth();
  </script>
</body>
</html>